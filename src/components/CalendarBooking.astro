---
import servicesData from '../data/services.json';
const services = servicesData.services;
---

<div id="calendar-booking-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 rounded-t-2xl">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Programează Consultație</h2>
                <button id="close-calendar-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
        </div>

        <div class="p-8">
            <!-- Service Selection -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Selectează serviciul dorit:</h3>
                <div class="space-y-3">
                    {services.map((service) => (
                        <label class="flex items-center justify-between p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-primary transition-colors service-option">
                            <div class="flex items-center flex-1">
                                <input type="radio" name="service" value={service.name} data-duration={service.duration} data-duration-minutes={service.durationMinutes} class="w-5 h-5 text-primary focus:ring-primary" />
                                <div class="ml-3">
                                    <div class="text-gray-900 font-medium">
                                        {service.name} <span class="text-xs text-gray-400">({service.subtitle})</span> <span class="text-sm text-gray-500">⏱ {service.duration}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                {service.priceOld && (
                                    <div class="text-sm text-gray-400 line-through">{service.priceOld} RON</div>
                                )}
                                <div class="text-lg font-semibold text-primary">{service.price} RON</div>
                            </div>
                        </label>
                    ))}
                </div>
            </div>

            <!-- Calendar Section -->
            <div id="calendar-section" class="hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Selectează data și ora:</h3>

                <!-- Week Navigation -->
                <div class="flex justify-between items-center mb-5">
                    <button id="prev-week" class="px-4 py-2 text-primary hover:bg-primary hover:text-white rounded-lg transition-colors">
                        <i class="fas fa-chevron-left mr-2"></i>Săptămâna anterioară
                    </button>
                    <span id="current-week-display" class="text-gray-700 font-medium"></span>
                    <button id="next-week" class="px-4 py-2 text-primary hover:bg-primary hover:text-white rounded-lg transition-colors">
                        Săptămâna următoare<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div class="overflow-x-auto">
                    <div class="min-w-[600px]">
                        <!-- Days Header -->
                        <div class="grid grid-cols-6 gap-2 mb-3">
                            <div class="text-center font-semibold text-gray-600 py-2">Interval</div>
                            <div class="text-center py-2">
                                <div class="font-semibold text-gray-600">Luni</div>
                                <div id="day-1-date" class="text-sm text-gray-500"></div>
                            </div>
                            <div class="text-center py-2">
                                <div class="font-semibold text-gray-600">Marți</div>
                                <div id="day-2-date" class="text-sm text-gray-500"></div>
                            </div>
                            <div class="text-center py-2">
                                <div class="font-semibold text-gray-600">Miercuri</div>
                                <div id="day-3-date" class="text-sm text-gray-500"></div>
                            </div>
                            <div class="text-center py-2">
                                <div class="font-semibold text-gray-600">Joi</div>
                                <div id="day-4-date" class="text-sm text-gray-500"></div>
                            </div>
                            <div class="text-center py-2">
                                <div class="font-semibold text-gray-600">Vineri</div>
                                <div id="day-5-date" class="text-sm text-gray-500"></div>
                            </div>
                        </div>

                        <!-- Time Slots -->
                        <div id="calendar-grid" class="space-y-3">
                            <!-- Morning Slot Row (180 min) -->
                            <div class="grid grid-cols-6 gap-2 slot-row" data-slot-duration="180">
                                <div class="flex items-center justify-center bg-gray-50 rounded-lg py-2 font-medium text-gray-700 text-sm">
                                    10:00-13:00
                                </div>
                                <div class="calendar-slot" data-slot="morning" data-slot-duration="180" data-day="1"></div>
                                <div class="calendar-slot" data-slot="morning" data-slot-duration="180" data-day="2"></div>
                                <div class="calendar-slot" data-slot="morning" data-slot-duration="180" data-day="3"></div>
                                <div class="calendar-slot" data-slot="morning" data-slot-duration="180" data-day="4"></div>
                                <div class="calendar-slot" data-slot="morning" data-slot-duration="180" data-day="5"></div>
                            </div>

                            <!-- Midday Slot Row (30 min) - Laser Only -->
                            <div class="grid grid-cols-6 gap-2 slot-row" data-slot-duration="30">
                                <div class="flex items-center justify-center bg-gray-50 rounded-lg py-2 font-medium text-gray-700 text-sm">
                                    13:00-13:30
                                </div>
                                <div class="calendar-slot" data-slot="midday" data-slot-duration="30" data-day="1"></div>
                                <div class="calendar-slot" data-slot="midday" data-slot-duration="30" data-day="2"></div>
                                <div class="calendar-slot" data-slot="midday" data-slot-duration="30" data-day="3"></div>
                                <div class="calendar-slot" data-slot="midday" data-slot-duration="30" data-day="4"></div>
                                <div class="calendar-slot" data-slot="midday" data-slot-duration="30" data-day="5"></div>
                            </div>

                            <!-- Afternoon Slot Row (180 min) -->
                            <div class="grid grid-cols-6 gap-2 slot-row" data-slot-duration="180">
                                <div class="flex items-center justify-center bg-gray-50 rounded-lg py-2 font-medium text-gray-700 text-sm">
                                    13:30-16:30
                                </div>
                                <div class="calendar-slot" data-slot="afternoon" data-slot-duration="180" data-day="1"></div>
                                <div class="calendar-slot" data-slot="afternoon" data-slot-duration="180" data-day="2"></div>
                                <div class="calendar-slot" data-slot="afternoon" data-slot-duration="180" data-day="3"></div>
                                <div class="calendar-slot" data-slot="afternoon" data-slot-duration="180" data-day="4"></div>
                                <div class="calendar-slot" data-slot="afternoon" data-slot-duration="180" data-day="5"></div>
                            </div>
                        </div>

                        <!-- Legend -->
                        <div class="mt-4 flex items-center justify-center gap-6 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-500 rounded"></div>
                                <span class="text-gray-600">Disponibil</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-500 rounded"></div>
                                <span class="text-gray-600">Ocupat</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script is:inline>
    // Calendar booking functionality
    let currentWeekOffset = 0;
    let selectedService = null;
    let selectedServiceDuration = null;
    let availabilityData = {};

    function initCalendarBooking() {
        // Service selection
        const serviceOptions = document.querySelectorAll('input[name="service"]');
        serviceOptions.forEach(option => {
            option.addEventListener('change', function() {
                selectedService = this.value;
                selectedServiceDuration = parseInt(this.dataset.durationMinutes);

                // Update visual feedback
                document.querySelectorAll('.service-option').forEach(opt => {
                    opt.classList.remove('border-primary', 'bg-primary', 'bg-opacity-5');
                });
                this.closest('.service-option').classList.add('border-primary', 'bg-primary', 'bg-opacity-5');

                // Show calendar section
                document.getElementById('calendar-section').classList.remove('hidden');

                // Filter slots based on service duration
                filterSlotsByDuration(selectedServiceDuration);
            });
        });

        // Week navigation
        document.getElementById('prev-week').addEventListener('click', () => {
            currentWeekOffset--;
            updateCalendar();
        });

        document.getElementById('next-week').addEventListener('click', () => {
            currentWeekOffset++;
            updateCalendar();
        });

        // Close modal
        document.getElementById('close-calendar-modal').addEventListener('click', () => {
            document.getElementById('calendar-booking-modal').classList.add('hidden');
            // Reset calendar section visibility
            document.getElementById('calendar-section').classList.add('hidden');
            // Reset service selection
            selectedService = null;
            selectedServiceDuration = null;
            document.querySelectorAll('input[name="service"]').forEach(opt => opt.checked = false);
            document.querySelectorAll('.service-option').forEach(opt => {
                opt.classList.remove('border-primary', 'bg-primary', 'bg-opacity-5');
            });
        });

        // Initial calendar load
        updateCalendar();
    }

    function updateCalendar() {
        const today = new Date();
        const currentWeekStart = new Date(today);
        currentWeekStart.setDate(today.getDate() + (currentWeekOffset * 7) - today.getDay() + 1); // Start on Monday

        // Update week display
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(currentWeekStart.getDate() + 4); // Friday

        const weekDisplay = document.getElementById('current-week-display');
        weekDisplay.textContent = formatWeekRange(currentWeekStart, weekEnd);

        // Update day dates
        for (let i = 0; i < 5; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(currentWeekStart.getDate() + i);
            const dayDateElement = document.getElementById(`day-${i + 1}-date`);
            if (dayDateElement) {
                dayDateElement.textContent = date.getDate();
            }
        }

        // Fetch availability from API
        fetchAvailability(currentWeekStart);
    }

    async function fetchAvailability(weekStart) {
        try {
            const response = await fetch(`/api/calendar-availability?date=${weekStart.toISOString()}`);
            const data = await response.json();

            if (data.success) {
                renderCalendar(data.availability, weekStart);
            } else {
                console.error('Error fetching availability:', data.error);
                // Fallback to mock data
                const mockData = generateMockAvailability(weekStart);
                renderCalendar(mockData, weekStart);
            }
        } catch (error) {
            console.error('Error fetching availability:', error);
            // Fallback to mock data
            const mockData = generateMockAvailability(weekStart);
            renderCalendar(mockData, weekStart);
        }
    }

    function generateMockAvailability(weekStart) {
        const availability = {};
        for (let i = 0; i < 5; i++) {
            const date = new Date(weekStart);
            date.setDate(weekStart.getDate() + i);
            const dateKey = date.toISOString().split('T')[0];
            availability[dateKey] = {
                morning: Math.random() > 0.3, // 70% available
                midday: Math.random() > 0.3,  // 70% available
                afternoon: Math.random() > 0.3
            };
        }
        return availability;
    }

    function filterSlotsByDuration(durationMinutes) {
        const slotRows = document.querySelectorAll('.slot-row');

        slotRows.forEach(row => {
            const slotDuration = parseInt(row.dataset.slotDuration);

            // Show all slots if no service selected
            if (!durationMinutes) {
                row.style.display = '';
                return;
            }

            // If service needs 180 min, show only 180 min slots
            if (durationMinutes === 180) {
                row.style.display = slotDuration === 180 ? '' : 'none';
            }
            // If service needs 30 min, show only 30 min slots
            else if (durationMinutes === 30) {
                row.style.display = slotDuration === 30 ? '' : 'none';
            }
            // Default: show all
            else {
                row.style.display = '';
            }
        });
    }

    function renderCalendar(availability, weekStart) {
        const slots = document.querySelectorAll('.calendar-slot');

        slots.forEach(slot => {
            const day = parseInt(slot.dataset.day);
            const slotType = slot.dataset.slot;

            const date = new Date(weekStart);
            date.setDate(weekStart.getDate() + (day - 1));
            const dateKey = date.toISOString().split('T')[0];

            const isAvailable = availability[dateKey]?.[slotType] || false;

            // Clear previous classes
            slot.className = 'calendar-slot flex items-center justify-center rounded-lg py-2 cursor-pointer transition-all';

            if (isAvailable) {
                slot.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
                slot.innerHTML = '<i class="fas fa-check"></i>';
                slot.onclick = () => handleSlotClick(date, slotType);
            } else {
                slot.classList.add('bg-red-500', 'cursor-not-allowed', 'text-white', 'opacity-50');
                slot.innerHTML = '<i class="fas fa-times"></i>';
                slot.onclick = null;
            }

            // Store date info
            slot.dataset.date = dateKey;
        });
    }

    function handleSlotClick(date, slotType) {
        if (!selectedService) {
            alert('Selectează mai întâi serviciul dorit');
            return;
        }

        const timeSlots = {
            morning: '10:00-13:00',
            midday: '13:00-13:30',
            afternoon: '13:30-16:30'
        };

        const timeSlot = timeSlots[slotType] || timeSlots.morning;
        const formattedDate = formatDate(date);

        const message = `Bună! Aș dori să programez:\n🎯 Serviciu: ${selectedService}\n📅 Data: ${formattedDate}\n⏰ Ora: ${timeSlot}\n\nVă rog să îmi confirmați disponibilitatea.`;

        const whatsappUrl = `https://api.whatsapp.com/send/?phone=40732163268&text=${encodeURIComponent(message)}&type=phone_number&app_absent=0`;

        window.open(whatsappUrl, '_blank');
    }

    function formatDate(date) {
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        return date.toLocaleDateString('ro-RO', options);
    }

    function formatWeekRange(startDate, endDate) {
        const startDay = startDate.getDate();
        const endDay = endDate.getDate();
        const startMonth = startDate.toLocaleDateString('ro-RO', { month: 'long' });
        const endMonth = endDate.toLocaleDateString('ro-RO', { month: 'long' });
        const year = endDate.getFullYear();

        // If same month, show: "7 - 11 octombrie 2025"
        if (startMonth === endMonth) {
            return `${startDay} - ${endDay} ${startMonth} ${year}`;
        }

        // If different months, show: "30 septembrie - 4 octombrie 2025"
        return `${startDay} ${startMonth} - ${endDay} ${endMonth} ${year}`;
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCalendarBooking);
    } else {
        initCalendarBooking();
    }
</script>

<style>
    .service-option input:checked ~ span {
        color: #B29D8B;
    }

    #calendar-booking-modal {
        backdrop-filter: blur(4px);
    }
</style>
